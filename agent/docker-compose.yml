services:
  # Neo4j Knowledge Graph Database
  neo4j:
    image: neo4j:5.15-community
    container_name: jarvis-neo4j
    ports:
      - "7474:7474"  # Neo4j Browser
      - "7687:7687"  # Bolt protocol
    environment:
      NEO4J_AUTH: neo4j/jarvispassword
      NEO4J_dbms_memory_heap_initial__size: "512m"
      NEO4J_dbms_memory_heap_max__size: "2G"
      NEO4J_dbms_memory_pagecache_size: "512m"
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    networks:
      - jarvis-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "jarvispassword", "RETURN 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Zookeeper for Kafka
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: jarvis-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - jarvis-network
    restart: unless-stopped

  # Kafka Message Broker
  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: jarvis-kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
    depends_on:
      - zookeeper
    networks:
      - jarvis-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Ollama LLM Service (shared by multiple agents)  
  ollama:
    build:
      context: .
      dockerfile: ./ollama/Dockerfile
    container_name: ${CONTAINER_NAME:-jarvis-ollama}
    ports:
      - "11434:11434"
    networks:
      - jarvis-network
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # PostgreSQL Database with pgvector extension
  postgres:
    image: ankane/pgvector:v0.5.1
    container_name: jarvis-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: jarvis
      POSTGRES_USER: jarvis
      POSTGRES_PASSWORD: jarvispassword
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./visual_analyser/migrations:/docker-entrypoint-initdb.d
    networks:
      - jarvis-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U jarvis"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Jarvis General Agent Service
  agent-general:
    build:
      context: .
      dockerfile: ./general/Dockerfile
    container_name: ${CONTAINER_NAME:-jarvis-agent-general}
    ports:
      - "${CLI_PORT:-8081}:8080"
    environment:
      - OLLAMA_HOST=http://ollama:11434
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.2}
      - AGENT_MODE=http
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=jarvispassword
      - USER_ID=${USER_ID:-default}
      - KAFKA_BROKERS=kafka:29092
    depends_on:
      postgres:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      kafka:
        condition: service_healthy
      ollama:
        condition: service_healthy
    networks:
      - jarvis-network
    restart: unless-stopped

  # Jarvis Router Agent Service
  agent-router:
    build:
      context: .
      dockerfile: ./router/Dockerfile
    container_name: jarvis-agent-router
    ports:
      - "8083:8080"
    environment:
      - AGENT_MODE=http
      - KAFKA_BROKERS=kafka:29092
      - USER_ID=${USER_ID:-default}
      - OLLAMA_HOST=http://ollama:11434
      - OLLAMA_TEST_MODEL=llama3.2
    depends_on:
      kafka:
        condition: service_healthy
      ollama:
        condition: service_healthy
    networks:
      - jarvis-network
    restart: unless-stopped

  # Jarvis GUI Agent Service
  agent-gui:
    build:
      context: .
      dockerfile: ./gui-agent/Dockerfile
    container_name: jarvis-agent-gui
    ports:
      - "8082:8080"
    environment:
      - OLLAMA_HOST=http://ollama:11434
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.2}
      - USER_ID=${USER_ID:-default}
      - GUI_DAEMON_URL=http://gui-daemon:9990
      - VISUAL_ANALYSER_URL=http://visual-analyser:8080
      - KAFKA_BROKERS=kafka:29092
    depends_on:
      kafka:
        condition: service_healthy
      ollama:
        condition: service_healthy
      gui-daemon:
        condition: service_healthy
      visual-analyser:
        condition: service_healthy
    networks:
      - jarvis-network
    restart: unless-stopped

  # Jarvis GUI Daemon Service
  gui-daemon:
    build:
      context: .
      dockerfile: ./gui-daemon/Dockerfile
    container_name: jarvis-gui-daemon
    ports:
      - "9990:9990"
    environment:
      - PORT=9990
      - DISPLAY=:99
    networks:
      - jarvis-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9990/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

  # Jarvis Visual Analyser Service (GUI Screen Analysis)
  visual-analyser:
    build:
      context: .
      dockerfile: ./visual_analyser/Dockerfile
    container_name: jarvis-visual-analyser
    ports:
      - "8084:8080"
    environment:
      - PORT=8080
      - OLLAMA_HOST=http://ollama:11434
      - VISION_MODEL=${VISION_MODEL:-llama3.2-vision}
    depends_on:
      ollama:
        condition: service_healthy
    networks:
      - jarvis-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 15s

volumes:
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  neo4j_import:
    driver: local
  neo4j_plugins:
    driver: local
  postgres_data:
    driver: local
  ollama_data:
    driver: local

networks:
  jarvis-network:
    driver: bridge